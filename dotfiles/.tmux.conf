# =============================================================================
# Prefix Key Configuration - Container/Nested Detection
# =============================================================================
# Prefix key switching logic:
#   - Container (Docker/Podman) → Ctrl-a
#   - Nested tmux (TMUX env set) → Ctrl-a  
#   - Normal (host/single tmux)  → Ctrl-b (default)
#
# Detection methods:
#   - /.dockerenv        : Docker container marker file
#   - /run/.containerenv : Podman container marker file
#   - $CONTAINER         : Container environment variable (uppercase)
#   - $container         : Container environment variable (lowercase, systemd-nspawn)
#   - $TMUX_PANE         : Set only when running inside existing tmux session
#                          (Note: $TMUX is not reliable because tmux's if-shell
#                           automatically sets $TMUX even on first startup)
# =============================================================================

# Check if running in container OR nested tmux, then use Ctrl-a as prefix
if-shell 'test -f /.dockerenv || test -f /run/.containerenv || test -n "$CONTAINER" || test -n "$container" || test -n "$TMUX_PANE"' {
    # Container or Nested: Use Ctrl-a as prefix
    set -g prefix C-a
    unbind C-b
    bind C-a send-prefix
    
    # Visual indicator in status bar for container/nested mode
    set -g status-left "[C-a] "
} {
    # Normal: Keep Ctrl-b as prefix (default)
    set -g prefix C-b
    bind C-b send-prefix
    
    # Visual indicator in status bar for normal mode
    set -g status-left "[C-b] "
}

# =============================================================================
# Status Right Configuration - Container Detection
# =============================================================================
# status-right display logic:
#   - Container (Docker/Podman) → Show hostname only (#H)
#   - Host/Normal               → Show date and time
#
# Note: TMUX_PANE is not available in run-shell context, so nested detection
#       is not reliable. Using container detection as the primary criteria.
# =============================================================================

run-shell '
    is_container() {
        test -f /.dockerenv || test -f /run/.containerenv || test -n "$CONTAINER" || test -n "$container"
    }
    
    if is_container; then
        # Container: Show hostname only (useful to identify which container)
        tmux set -g status-right "#H"
    else
        # Host/Normal: Show date and time
        tmux set -g status-right "%Y-%m-%d %H:%M"
    fi
'

# =============================================================================
# General Settings
# =============================================================================

# True color support
set -g default-terminal "screen-256color"
set-option -sa terminal-overrides ",xterm*:Tc"

# UTF-8 support for icons
setw -q -g utf8 on

# OSC 52 clipboard support - allow passthrough
set -g set-clipboard on

# Pass through environment variables for proper locale
set-option -ga update-environment " LC_ALL LANG"

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1
set -g mouse on

# Increase scrollback buffer size (default: 2000)
set -g history-limit 10000

# Eliminate escape key delay (useful for Vim users)
set -sg escape-time 0

# =============================================================================
# Pane Splitting - Intuitive Key Bindings
# =============================================================================
# | : Split window horizontally (panes side by side)
# - : Split window vertically (panes stacked)
# =============================================================================

bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# =============================================================================
# Vim-style Pane Navigation
# =============================================================================
# h/j/k/l : Move between panes (like Vim)
# =============================================================================

bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# =============================================================================
# Pane Resizing with Shift + h/j/k/l
# =============================================================================
# H/J/K/L : Resize panes by 5 cells
# =============================================================================

bind-key H resize-pane -L 5
bind-key J resize-pane -D 5
bind-key K resize-pane -U 5
bind-key L resize-pane -R 5

# =============================================================================
# Configuration Reload
# =============================================================================
# r : Reload tmux configuration with confirmation message
# =============================================================================

bind-key r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Set Status bar trasnparent
set-option -g status-style bg=default

# =============================================================================
# Window Status Styling
# =============================================================================

# Current window: Highlight with bright cyan and bold for visibility
set -g window-status-current-style "fg=brightcyan,bold"

# Non-current windows: Dimmed appearance
set -g window-status-style "fg=colour244"

# =============================================================================
# Cheatsheet Popup (prefix + ?)
# =============================================================================
# Display a customizable cheatsheet in a popup window
# - Cheatsheet file: ~/.config/tmux/cheatsheet.txt
# - Press 'q' or 'Esc' to close the popup
# - Customize the cheatsheet by editing the file above
#
# Note: Changed from 'h' to '?' to avoid conflict with Vim-style pane navigation
# Requirements: tmux 3.2+ (for display-popup support)
# =============================================================================

# Cheatsheet file path (can be customized)
TMUX_CHEATSHEET_FILE="$HOME/.config/tmux/cheatsheet.txt"

# Bind '?' to show cheatsheet popup (unbind default list-keys first)
# - Uses 'less' with options for better viewing
# - -S: Don't wrap long lines (use arrow keys to scroll horizontally)
# - -R: Allow ANSI colors
# - Popup size: 80% width, 80% height, centered
unbind-key ?
bind-key ? display-popup -w 80% -h 80% -E "less -RS ~/.config/tmux/cheatsheet.txt"
